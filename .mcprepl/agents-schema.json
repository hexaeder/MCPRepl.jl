{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "MCPRepl Agents Configuration",
  "description": "Configuration for multi-agent supervisor system with per-agent security settings",
  "type": "object",
  "properties": {
    "supervisor": {
      "type": "object",
      "description": "Supervisor process configuration",
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["lax", "relaxed", "strict"],
          "description": "Security mode: lax (no auth, localhost), relaxed (API key, localhost), strict (API key + IP allowlist)"
        },
        "host": {
          "type": "string",
          "description": "Host address to bind to (e.g., '127.0.0.1' for localhost, '0.0.0.0' for all interfaces)",
          "default": "127.0.0.1"
        },
        "port": {
          "type": "integer",
          "minimum": 1024,
          "maximum": 65535,
          "description": "Port number for supervisor's MCP server"
        },
        "api_keys": {
          "type": "array",
          "description": "List of valid API keys (empty array for lax mode)",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "allowed_ips": {
          "type": "array",
          "description": "IP allowlist in CIDR notation (only enforced in strict mode)",
          "items": {
            "type": "string",
            "pattern": "^(\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}(/\\d{1,2})?|::[0-9a-fA-F:]+(/\\d{1,3})?)$"
          },
          "default": []
        },
        "heartbeat_interval_seconds": {
          "type": "integer",
          "minimum": 1,
          "description": "How often to check for agent heartbeats (seconds)",
          "default": 1
        },
        "heartbeat_timeout_count": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of missed heartbeats before declaring agent dead",
          "default": 5
        },
        "max_restarts_per_hour": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum number of times an agent can be restarted per hour (rate limit)",
          "default": 10
        }
      },
      "required": ["mode", "host", "port", "api_keys", "allowed_ips", "heartbeat_interval_seconds", "heartbeat_timeout_count", "max_restarts_per_hour"]
    },
    "agents": {
      "type": "object",
      "description": "Agent configurations keyed by agent name",
      "patternProperties": {
        "^[a-z0-9-]+$": {
          "type": "object",
          "properties": {
            "mode": {
              "type": "string",
              "enum": ["lax", "relaxed", "strict"],
              "description": "Security mode for this agent"
            },
            "host": {
              "type": "string",
              "description": "Host address to bind this agent's MCP server to",
              "default": "127.0.0.1"
            },
            "port": {
              "type": "integer",
              "minimum": 1024,
              "maximum": 65535,
              "description": "Port number for this agent's MCP server"
            },
            "api_keys": {
              "type": "array",
              "description": "List of valid API keys for this agent",
              "items": {
                "type": "string"
              },
              "default": []
            },
            "allowed_ips": {
              "type": "array",
              "description": "IP allowlist for this agent (only enforced in strict mode)",
              "items": {
                "type": "string",
                "pattern": "^(\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}(/\\d{1,2})?|::[0-9a-fA-F:]+(/\\d{1,3})?)$"
              },
              "default": []
            },
            "directory": {
              "type": "string",
              "description": "Relative path to agent's working directory (e.g., 'agents/test-fixer')"
            },
            "description": {
              "type": "string",
              "description": "Human-readable description of what this agent does"
            },
            "auto_start": {
              "type": "boolean",
              "description": "Whether to automatically start this agent when supervisor starts",
              "default": true
            },
            "restart_policy": {
              "type": "string",
              "enum": ["always", "on_failure", "never"],
              "description": "When to restart: always (any stop), on_failure (crashes only), never (manual only)",
              "default": "on_failure"
            },
            "supervisor_host": {
              "type": "string",
              "description": "Optional: hostname/IP of supervisor for heartbeats (default: localhost)"
            },
            "supervisor_port": {
              "type": "integer",
              "minimum": 1024,
              "maximum": 65535,
              "description": "Optional: port of supervisor for heartbeats (default: 3000)"
            }
          },
          "required": ["mode", "host", "port", "api_keys", "allowed_ips", "directory", "description", "auto_start", "restart_policy"]
        }
      }
    }
  },
  "required": ["supervisor", "agents"]
}
