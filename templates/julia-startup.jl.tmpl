using Pkg
Pkg.activate(".")
import Base.Threads

# If running as agent, ensure MCPRepl and other dependencies are synced from supervisor
# Check if agent name was set via -e flag (global MCPREPL_AGENT_NAME)
agent_name = if isdefined(Main, :MCPREPL_AGENT_NAME)
    String(Main.MCPREPL_AGENT_NAME)
else
    ""
end
if !isempty(agent_name)
    # Check if MCPRepl is actually installed (not just listed in Project.toml)
    mcprepl_installed = try
        Base.find_package("MCPRepl") !== nothing
    catch
        false
    end

    @info "Agent '$(agent_name)' checking dependencies" mcprepl_installed=mcprepl_installed

    # Always sync/update MCPRepl from supervisor to ensure we have the latest version
    @info "Agent '$(agent_name)': Syncing dependencies from supervisor environment..."

    # Find supervisor project (parent directory)
    supervisor_project_path = joinpath(dirname(pwd()), "Project.toml")

    if isfile(supervisor_project_path)
        using TOML
        supervisor_project = TOML.parsefile(supervisor_project_path)
        supervisor_deps = get(supervisor_project, "deps", Dict())

        # Check if supervisor is using dev version
        supervisor_manifest_path = joinpath(dirname(pwd()), "Manifest.toml")
        mcprepl_info = nothing

        if isfile(supervisor_manifest_path)
            supervisor_manifest = TOML.parsefile(supervisor_manifest_path)

            # Manifest format: deps[PackageName] is an array of version entries
            if haskey(supervisor_manifest, "deps") && haskey(supervisor_manifest["deps"], "MCPRepl")
                mcprepl_entries = supervisor_manifest["deps"]["MCPRepl"]
                # Take the first entry (usually only one)
                if !isempty(mcprepl_entries)
                    mcprepl_info = mcprepl_entries[1]
                end
            end
        end

        # Sync MCPRepl (required)
        if mcprepl_info !== nothing && haskey(mcprepl_info, "path")
            # Dev version - use the same path
            dev_path = joinpath(dirname(pwd()), mcprepl_info["path"])
            @info "  Using MCPRepl dev version from: $(dev_path)"
            Pkg.develop(path=dev_path)
        elseif mcprepl_info !== nothing && haskey(mcprepl_info, "repo-url")
            # Git repository version
            repo_url = mcprepl_info["repo-url"]
            if haskey(mcprepl_info, "repo-rev")
                # Specific branch/rev
                repo_rev = mcprepl_info["repo-rev"]
                @info "  Adding/updating MCPRepl from: $(repo_url)#$(repo_rev)"
                Pkg.add(url=repo_url, rev=repo_rev)
            else
                @info "  Adding/updating MCPRepl from: $(repo_url)"
                Pkg.add(url=repo_url)
            end
        else
            # Registered version or no manifest info - just add it
            @info "  Adding MCPRepl package"
            Pkg.add("MCPRepl")
        end

        # Sync Revise if supervisor has it (optional but recommended)
        if haskey(supervisor_deps, "Revise")
            @info "  Adding Revise package (for hot reloading)"
            Pkg.add("Revise")
        end

        # Instantiate to ensure all dependencies are ready
        Pkg.instantiate()
    else
        @warn "Could not find supervisor Project.toml at $(supervisor_project_path)"
        @info "  Adding MCPRepl package anyway"
        Pkg.add("MCPRepl")
        Pkg.instantiate()
    end
end

# Load Revise for hot reloading (optional but recommended)
try
    using Revise
    @info "✓ Revise loaded - code changes will be tracked and auto-reloaded"
catch e
    @info "ℹ Revise not loaded (optional - install with: Pkg.add(\"Revise\"))"
end
using MCPRepl

# Start MCP REPL server for AI agent integration
try
    if Threads.threadid() == 1
        Threads.@spawn begin
            try
                sleep(1)

                # Ensure proxy server is running first
                proxy_port = 3000
                if !MCPRepl.Proxy.is_server_running(proxy_port)
                    # Start proxy silently - MCPRepl.start! will show progress via spinner
                    MCPRepl.Proxy.start_server(proxy_port; background=true)
                    sleep(1)  # Give proxy time to start
                end

                # Check if supervisor mode or agent name was set via -e flags
                supervisor_enabled = isdefined(Main, :MCPREPL_SUPERVISOR) ? Main.MCPREPL_SUPERVISOR : false
                agent_name_arg = isdefined(Main, :MCPREPL_AGENT_NAME) ? String(Main.MCPREPL_AGENT_NAME) : ""

                # Get project root directory (for agents to find agents.json)
                # When running as an agent, pwd() is the agent dir, but we need project root
                project_root = isdefined(Main, :MCPREPL_PROJECT_ROOT) ? String(Main.MCPREPL_PROJECT_ROOT) : pwd()

                # Start MCPRepl with parsed arguments
                # Port is determined by .mcprepl/security.json or agents.json
                # Heartbeats are automatically started if agent_name is provided
                # Check if agent_name parameter is supported (for backward compatibility)
                start_methods = methods(MCPRepl.start!)
                has_agent_name = any(m -> :agent_name in Base.kwarg_decl(m), start_methods)

                if has_agent_name
                    MCPRepl.start!(verbose=false, supervisor=supervisor_enabled, agent_name=agent_name_arg, workspace_dir=project_root)
                else
                    MCPRepl.start!(verbose=false, supervisor=supervisor_enabled)
                end

                # Wait a moment for server to fully initialize
                sleep(0.5)

                # Startup complete - prompt is already clean from start!()
                # No need for extra logging or prompt refresh
                if isdefined(Base, :active_repl)
                    try
                        REPL.LineEdit.refresh_line(Base.active_repl.mistate)
                    catch
                        # Ignore if REPL isn't ready yet
                    end
                end
            catch e
                @warn "Could not start MCP REPL server" exception=e
            end
        end
    end
catch e
    @warn "Could not start MCP REPL server" exception=e
end
