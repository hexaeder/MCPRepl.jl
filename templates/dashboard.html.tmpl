<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCPRepl Multi-Agent Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #131837;
            --bg-tertiary: #1a2140;
            --bg-card: #1e2749;
            --accent-primary: #00d9ff;
            --accent-secondary: #7c3aed;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-tertiary: #64748b;
            --border: rgba(255, 255, 255, 0.08);
            --shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 30px 60px rgba(0, 0, 0, 0.7);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        header {
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            padding: 1.25rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 100;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                var(--accent-primary) 0%, 
                var(--accent-secondary) 50%, 
                var(--accent-primary) 100%);
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .header-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 217, 255, 0.3);
        }
        
        h1 { 
            font-size: 1.5rem; 
            font-weight: 600;
            background: linear-gradient(135deg, var(--text-primary), var(--accent-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-stats {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status { 
            display: flex; 
            align-items: center; 
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 20px;
        }
        
        .status-indicator {
            position: relative;
            width: 12px;
            height: 12px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-success);
            animation: pulse 2s ease-in-out infinite;
        }
        
        .status-ring {
            position: absolute;
            top: -4px;
            left: -4px;
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent-success);
            border-radius: 50%;
            animation: ring 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.6;
                transform: scale(0.9);
            }
        }
        
        @keyframes ring {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        .status-text {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--accent-success);
        }
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .sidebar-title {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
        }
        
        .agent-count {
            background: var(--bg-card);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent-primary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .agent-card {
            background: var(--bg-card);
            padding: 1.25rem;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .agent-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-primary);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .agent-card:hover { 
            transform: translateX(4px);
            border-color: var(--border);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }
        
        .agent-card:hover::before {
            opacity: 1;
        }
        
        .agent-card.active { 
            border-color: var(--accent-primary);
            background: var(--bg-tertiary);
            box-shadow: 0 0 0 1px var(--accent-primary), 0 8px 30px rgba(0, 217, 255, 0.2);
        }
        
        .agent-card.active::before {
            opacity: 1;
        }
        
        .agent-card.status-ready::before { background: var(--accent-success); }
        .agent-card.status-busy::before { background: var(--accent-warning); }
        .agent-card.status-error::before { background: var(--accent-error); }
        .agent-card.status-stopped::before { background: var(--text-tertiary); }
        
        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        
        .agent-name { 
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .agent-status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .agent-status-badge.ready {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-success);
        }
        
        .agent-status-badge.busy {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-warning);
        }
        
        .agent-status-badge.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-error);
        }
        
        .agent-status-badge.stopped {
            background: rgba(100, 116, 139, 0.2);
            color: var(--text-tertiary);
        }
        
        .agent-meta { 
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .agent-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .agent-meta-label {
            color: var(--text-tertiary);
        }
        
        .agent-heartbeat {
            margin-top: 0.75rem;
            height: 40px;
            position: relative;
        }
        
        .heartbeat-canvas {
            width: 100%;
            height: 100%;
            opacity: 0.8;
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-primary);
        }
        
        .tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 2rem;
            gap: 0.5rem;
        }
        
        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text-secondary);
            position: relative;
        }
        
        .tab::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 3px 3px 0 0;
        }
        
        .tab:hover { 
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.03);
        }
        
        .tab.active { 
            color: var(--accent-primary);
        }
        
        .tab.active::before {
            transform: translateX(-50%) scaleX(1);
        }
        .view {
            flex: 1;
            overflow: auto;
            padding: 2rem;
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .view.active { display: block; }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .view::-webkit-scrollbar {
            width: 8px;
        }
        
        .view::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .view::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        .view::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        .event-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .event {
            background: var(--bg-card);
            padding: 1.25rem;
            border-radius: 12px;
            border-left: 4px solid var(--accent-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            transition: all 0.2s;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .event:hover {
            background: var(--bg-tertiary);
            transform: translateX(4px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .event-tool { border-left-color: var(--accent-warning); }
        .event-output { border-left-color: var(--accent-success); }
        .event-error { border-left-color: var(--accent-error); }
        
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .event-agent {
            font-weight: 600;
            color: var(--accent-primary);
        }
        
        .event-time {
            color: var(--text-tertiary);
            font-size: 0.75rem;
        }
        
        .event-body { 
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .event-type {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            background: rgba(0, 217, 255, 0.1);
            color: var(--accent-primary);
        }
        
        .terminal {
            background: var(--bg-secondary);
            padding: 2rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            height: 100%;
            overflow-y: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        
        .terminal-line {
            padding: 0.375rem 0;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        
        .terminal-prompt { 
            color: var(--accent-primary);
            font-weight: 600;
        }
        
        .terminal-output { 
            color: var(--text-secondary);
        }
        
        .terminal-error { 
            color: var(--accent-error);
            font-weight: 500;
        }
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .metric-card {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            border-color: rgba(0, 217, 255, 0.3);
        }
        
        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 20px rgba(0, 217, 255, 0.3);
        }
        
        .metric-value {
            font-size: 3rem;
            font-weight: 700;
            margin: 0.5rem 0;
            background: linear-gradient(135deg, var(--text-primary), var(--accent-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .metric-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .metric-change {
            margin-top: 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .metric-change.positive {
            color: var(--accent-success);
        }
        
        .metric-change.negative {
            color: var(--accent-error);
        }
    </style>
</head>
<body>
    <header>
        <div class="header-brand">
            <div class="logo">üîå</div>
            <h1>MCPRepl Dashboard</h1>
        </div>
        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-value" id="header-agents">0</div>
                <div class="stat-label">Agents</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="header-events">0</div>
                <div class="stat-label">Events</div>
            </div>
            <div class="status">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <div class="status-ring"></div>
                </div>
                <span class="status-text" id="connection-status">Connected</span>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Active Agents</div>
                <div class="agent-count" id="agent-count">0</div>
            </div>
            <div id="agent-list"></div>
        </div>
        
        <div class="main-content">
            <div class="tabs">
                <div class="tab active" data-view="overview">Overview</div>
                <div class="tab" data-view="activity">Activity Feed</div>
                <div class="tab" data-view="terminal">Agent Terminal</div>
            </div>
            
            <div id="overview-view" class="view active">
                <div class="overview-grid" id="overview-metrics"></div>
            </div>
            
            <div id="activity-view" class="view">
                <div class="event-list" id="event-list"></div>
            </div>
            
            <div id="terminal-view" class="view">
                <div class="terminal" id="terminal-output">
                    <div class="terminal-line">Select an agent from the sidebar to view its output</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let ws = null;
        let selectedAgent = null;
        let agents = {};
        let events = [];
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(protocol + '//' + window.location.host + '/dashboard/ws');
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('connection-status').textContent = 'Connected';
                loadInitialData();
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleEvent(data);
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                document.getElementById('connection-status').textContent = 'Disconnected';
                setTimeout(connectWebSocket, 2000);
            };
        }
        
        async function loadInitialData() {
            try {
                const response = await fetch('/dashboard/api/agents');
                agents = await response.json();
                renderAgents();
                renderOverview();
                
                const eventsResponse = await fetch('/dashboard/api/events');
                events = await eventsResponse.json();
                renderEvents();
            } catch (e) {
                console.error('Failed to load initial data:', e);
            }
        }
        
        function handleEvent(event) {
            events.unshift(event);
            if (events.length > 1000) events.pop();
            
            // Update agent state
            if (!agents[event.id]) {
                agents[event.id] = { id: event.id, events: [] };
            }
            agents[event.id].last_event = event.timestamp;
            
            renderAgents();
            renderEvents();
            renderOverview();
            
            if (selectedAgent === event.id) {
                appendTerminalOutput(event);
            }
        }
        
        // EKG Visualization
        const ekgData = {};
        
        function initEKG(agentId) {
            if (!ekgData[agentId]) {
                ekgData[agentId] = {
                    points: Array(100).fill(0.5),
                    lastBeat: Date.now()
                };
            }
        }
        
        function drawEKG(canvas, agentId) {
            if (!canvas || !ekgData[agentId]) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth * 2;
            const height = canvas.height = canvas.offsetHeight * 2;
            ctx.scale(2, 2);
            
            const data = ekgData[agentId].points;
            const timeSinceBeat = Date.now() - ekgData[agentId].lastBeat;
            
            // Trigger heartbeat spike
            if (timeSinceBeat < 100) {
                const progress = timeSinceBeat / 100;
                data[data.length - 1] = 0.5 + Math.sin(progress * Math.PI * 4) * 0.4;
            } else {
                data[data.length - 1] = 0.5 + (Math.random() - 0.5) * 0.05;
            }
            
            // Shift data left
            data.shift();
            data.push(data[data.length - 1]);
            
            // Draw
            ctx.clearRect(0, 0, width / 2, height / 2);
            ctx.strokeStyle = 'rgba(0, 217, 255, 0.6)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            data.forEach((value, i) => {
                const x = (i / data.length) * (width / 2);
                const y = value * (height / 2);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            
            ctx.stroke();
            
            // Glow effect
            ctx.strokeStyle = 'rgba(0, 217, 255, 0.2)';
            ctx.lineWidth = 4;
            ctx.stroke();
        }
        
        function triggerHeartbeat(agentId) {
            initEKG(agentId);
            ekgData[agentId].lastBeat = Date.now();
        }
        
        function renderAgents() {
            const list = document.getElementById('agent-list');
            const agentArray = Object.values(agents);
            
            document.getElementById('agent-count').textContent = agentArray.length;
            document.getElementById('header-agents').textContent = agentArray.length;
            
            list.innerHTML = agentArray.map(agent => {
                const status = getAgentStatus(agent);
                initEKG(agent.id);
                
                return `
                    <div class="agent-card status-${status} ${selectedAgent === agent.id ? 'active' : ''}"
                         onclick="selectAgent('${agent.id}')">
                        <div class="agent-header">
                            <div class="agent-name">${agent.id}</div>
                            <div class="agent-status-badge ${status}">${status}</div>
                        </div>
                        <div class="agent-meta">
                            <div class="agent-meta-item">
                                <span class="agent-meta-label">Port:</span>
                                <span>${agent.port || '?'}</span>
                            </div>
                            <div class="agent-meta-item">
                                <span class="agent-meta-label">PID:</span>
                                <span>${agent.pid || '?'}</span>
                            </div>
                        </div>
                        <div class="agent-heartbeat">
                            <canvas class="heartbeat-canvas" id="ekg-${agent.id}"></canvas>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Start EKG animations
            agentArray.forEach(agent => {
                const canvas = document.getElementById(`ekg-${agent.id}`);
                if (canvas) {
                    const animate = () => {
                        drawEKG(canvas, agent.id);
                        requestAnimationFrame(animate);
                    };
                    animate();
                }
            });
        }
        
        function renderEvents() {
            const list = document.getElementById('event-list');
            document.getElementById('header-events').textContent = events.length;
            
            list.innerHTML = events.slice(0, 100).map(event => {
                const typeClass = event.type.toLowerCase().replace('_', '-');
                return `
                    <div class="event event-${typeClass}">
                        <div class="event-type">${event.type}</div>
                        <div class="event-header">
                            <span class="event-agent">${event.id}</span>
                            <span class="event-time">${event.timestamp}</span>
                        </div>
                        <div class="event-body">
                            ${event.data.description || event.data.tool || event.data.method || JSON.stringify(event.data)}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderOverview() {
            const metrics = document.getElementById('overview-metrics');
            const agentCount = Object.keys(agents).length;
            const eventCount = events.length;
            const activeCount = Object.values(agents).filter(a => 
                getAgentStatus(a) !== 'stopped'
            ).length;
            
            // Calculate recent activity (last minute)
            const recentEvents = events.filter(e => {
                const eventTime = new Date(e.timestamp);
                const now = new Date();
                return (now - eventTime) < 60000;
            }).length;
            
            const errors = events.filter(e => e.type === 'ERROR').length;
            const toolCalls = events.filter(e => e.type === 'TOOL_CALL').length;
            
            metrics.innerHTML = `
                <div class="metric-card">
                    <div class="metric-icon">üë•</div>
                    <div class="metric-content">
                        <div class="metric-label">Total Agents</div>
                        <div class="metric-value">${agentCount}</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">‚ö°</div>
                    <div class="metric-content">
                        <div class="metric-label">Active Agents</div>
                        <div class="metric-value">${activeCount}</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üìä</div>
                    <div class="metric-content">
                        <div class="metric-label">Total Events</div>
                        <div class="metric-value">${eventCount}</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üî•</div>
                    <div class="metric-content">
                        <div class="metric-label">Events/min</div>
                        <div class="metric-value">${recentEvents}</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">‚ö†Ô∏è</div>
                    <div class="metric-content">
                        <div class="metric-label">Errors</div>
                        <div class="metric-value">${errors}</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üîß</div>
                    <div class="metric-content">
                        <div class="metric-label">Tool Calls</div>
                        <div class="metric-value">${toolCalls}</div>
                    </div>
                </div>
            `;
        }
        
        function selectAgent(id) {
            selectedAgent = id;
            renderAgents();
            loadAgentTerminal(id);
        }
        
        async function loadAgentTerminal(id) {
            const terminal = document.getElementById('terminal-output');
            terminal.innerHTML = '<div class="terminal-line terminal-prompt">Loading agent output...</div>';
            
            try {
                const response = await fetch(`/dashboard/api/events?id=${id}&limit=500`);
                const agentEvents = await response.json();
                
                terminal.innerHTML = agentEvents.map(event => 
                    formatTerminalEvent(event)
                ).join('');
            } catch (e) {
                terminal.innerHTML = '<div class="terminal-line terminal-error">Failed to load terminal output</div>';
            }
        }
        
        function appendTerminalOutput(event) {
            const terminal = document.getElementById('terminal-output');
            const line = document.createElement('div');
            line.innerHTML = formatTerminalEvent(event);
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        function formatTerminalEvent(event) {
            const time = event.timestamp.split(' ')[1] || event.timestamp;
            const typeColors = {
                'CODE_EXECUTION': '#7c3aed',
                'OUTPUT': '#4ade80',
                'ERROR': '#ff4444',
                'TOOL_CALL': '#00d9ff',
                'HEARTBEAT': '#666',
                'AGENT_START': '#4ade80',
                'AGENT_STOP': '#ff4444'
            };
            const color = typeColors[event.type] || '#888';
            
            if (event.type === 'CODE_EXECUTION') {
                return `<div class="terminal-line"><span class="terminal-prompt" style="color: ${color}">[${time}] julia> </span><span style="color: #e0e0e0">${event.data.code || event.data.method || ''}</span></div>`;
            } else if (event.type === 'OUTPUT') {
                return `<div class="terminal-line terminal-output" style="color: ${color}">${event.data.output || event.data.result || ''}</div>`;
            } else if (event.type === 'ERROR') {
                return `<div class="terminal-line terminal-error" style="color: ${color}">ERROR: ${event.data.message || event.data.error || ''}</div>`;
            } else if (event.type === 'TOOL_CALL') {
                return `<div class="terminal-line"><span style="color: ${color}">[${time}] üîß ${event.data.tool || event.data.method || 'tool'}</span></div>`;
            }
            return `<div class="terminal-line" style="color: ${color}">[${time}] ${event.type}: ${event.data.description || JSON.stringify(event.data)}</div>`;
        }
        
        function getAgentStatus(agent) {
            if (!agent.last_event) return 'stopped';
            const lastEvent = new Date(agent.last_event);
            const now = new Date();
            const diff = (now - lastEvent) / 1000;
            return diff < 30 ? 'ready' : 'stopped';
        }
        
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.view + '-view').classList.add('active');
            });
        });
        
        // Initialize
        connectWebSocket();
    </script>
</body>
</html>
